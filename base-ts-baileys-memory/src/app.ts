import { createBot, createProvider, createFlow, addKeyword, MemoryDB } from '@builderbot/bot'
import { BaileysProvider } from '@builderbot/provider-baileys'
import { appointmentFlow, cancelAppointmentFlow } from './flows/appointment.flow'
import { patientFlow } from './flows/patient.flow'
import { Logger } from './utils/logger'

// ConfiguraciÃ³n de la API
const API_URL = 'http://localhost:3001/api' // AsegÃºrate de que esta URL sea correcta
const PORT = process.env.PORT ?? 3008

const welcomeFlow = addKeyword(['hola', 'buenos dÃ­as', 'buenas tardes', 'buenas noches', 'hi', 'hello'])
  .addAnswer('ðŸ‘‹ Â¡Hola! Soy el asistente virtual del consultorio mÃ©dico.')
  .addAnswer([
    'Â¿En quÃ© puedo ayudarte hoy?',
    '',
    '*Horarios de atenciÃ³n:*',
    'â€¢ MaÃ±ana: 08:30 a 11:30',
    'â€¢ Tarde: 16:30 a 19:30',
    '',
    '1ï¸âƒ£ *Consultar horarios disponibles*',
    '2ï¸âƒ£ *Agendar una cita*',
    '3ï¸âƒ£ *Cancelar una cita*',
    '4ï¸âƒ£ *Registrarme como paciente*',
    '',
    'Responde con el nÃºmero de la opciÃ³n que deseas.'
  ])

const menuFlow = addKeyword(['menu', 'menÃº', 'opciones', 'ayuda', 'help'])
  .addAnswer([
    'ðŸ“‹ *MENÃš PRINCIPAL*',
    '',
    '1ï¸âƒ£ *Consultar horarios disponibles*',
    '2ï¸âƒ£ *Agendar una cita*',
    '3ï¸âƒ£ *Cancelar una cita*',
    '4ï¸âƒ£ *Registrarme como paciente*',
    '',
    'Responde con el nÃºmero de la opciÃ³n que deseas.'
  ])

const bookAppointmentFlow = addKeyword(['2', 'agendar', 'cita', 'turno'])
  .addAnswer('ðŸ“… Vamos a agendar una cita.')
  .addAnswer('Primero, consultemos los horarios disponibles.')
  .addAnswer('Â¿Para quÃ© fecha quieres consultar? (Formato: YYYY-MM-DD, ejemplo: 2025-03-15)')
  .addAction(async (ctx, { gotoFlow }) => {
    // Redirigir al flujo de consulta de horarios
    return gotoFlow(appointmentFlow)
  })

const main = async () => {
  const adapterDB = new MemoryDB()
  const adapterFlow = createFlow([
    welcomeFlow,
    menuFlow,
    bookAppointmentFlow,
    appointmentFlow,
    cancelAppointmentFlow,
    patientFlow
  ])
  const adapterProvider = createProvider(BaileysProvider, {
    writeMyself: 'host' as 'none' | 'host' | 'both'
  })

  const { httpServer } = await createBot({
    flow: adapterFlow,
    provider: adapterProvider,
    database: adapterDB,
  })

  httpServer(+PORT)
}

main()

// Agregar manejadores de errores no capturados
process.on('uncaughtException', (error) => {
  Logger.error('UNCAUGHT EXCEPTION:', error);
});

process.on('unhandledRejection', (reason, promise) => {
  Logger.error('UNHANDLED REJECTION:', reason);
});
